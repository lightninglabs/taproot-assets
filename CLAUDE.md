# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Test Commands

```bash
# Build debug binaries (tapd-debug, tapcli-debug)
make build

# Install release binaries to $GOPATH/bin
make install

# Run all unit tests
make unit

# Run unit tests for a specific package
make unit pkg=tapdb

# Run a specific test case
make unit pkg=tapdb case=TestAssetMinting

# Run unit tests with verbose output
make unit-debug pkg=tapdb case=TestAssetMinting

# Run unit tests with trace logging enabled
make unit-trace pkg=tapdb case=TestAssetMinting

# Run tests with postgres backend
make unit dbbackend=postgres pkg=tapdb case=TestAssetMinting

# Run integration tests (requires btcd, lnd binaries)
make itest-parallel

# Run specific integration test (test names from itest/test_list_on_test.go, snake_cased)
make itest icase=basic_send_unidirectional

# Run integration tests with trace logging
make itest-trace icase=basic_send_unidirectional

# Lint and format
make lint        # Runs golangci-lint via Docker
make fmt         # Format with gosimports and gofmt
```

## Code Generation

```bash
# Regenerate protobuf files
make rpc

# Regenerate SQL models (sqlc)
make sqlc

# Regenerate both
make gen
```

## Architecture Overview

### Core Components

**tapd** (cmd/tapd) - Main daemon that:
- Connects to `lnd` for wallet operations and signing
- Manages asset minting, transfers, and burns
- Serves gRPC (10029) and REST (8089) APIs
- Coordinates with Universe servers for proof distribution

**tapcli** (cmd/tapcli) - CLI tool for interacting with tapd

### Key Packages

| Package | Purpose |
|---------|---------|
| `asset` | Asset data structures, encoding, witness handling |
| `address` | Taproot Asset address creation and parsing |
| `commitment` | Taproot commitment structures (asset, tap, split) |
| `proof` | Proof file format, verification, archival |
| `tapdb` | Database layer (SQLite/Postgres), migrations |
| `tapgarden` | Asset minting (Planter) and receiving (Custodian) |
| `tapfreighter` | Asset sending and anchoring |
| `tapsend` | Transaction construction for sends |
| `universe` | Universe server, federation sync, multiverse |
| `rfq` | Request For Quote system for Lightning payments |
| `rfqmath` | Fixed-point arithmetic for RFQ |
| `rfqmsg` | RFQ wire protocol messages |
| `mssmt` | Merkle-Sum Sparse Merkle Tree implementation |
| `vm` | Taproot Assets virtual machine for script execution |
| `tapchannel` | Lightning channel integration |
| `fn` | Functional utilities (Option, Either, Result types) |

### Database Layer

- **SQLite** (default): `~/.tapd/data/<network>/tapd.db`
- **Postgres**: Configure via `--postgres.*` flags
- Migrations in `tapdb/sqlc/migrations/`
- SQL queries generated by sqlc in `tapdb/sqlc/`

To create a new migration:
```bash
make migrate-create patchname=<description>
```

### Testing Patterns

Unit tests use build tags for database backend selection:
- Default: SQLite in-memory
- `test_db_postgres`: Use Postgres (requires running instance)

Integration tests (`itest/`) run full tapd instances with btcd and lnd. Test cases are registered in `itest/test_list_on_test.go`.

## Code Style Notes

- Max line length: 80 characters
- JSON struct tags use snake_case (enforced by tagliatelle linter)
- Lint runs only on new code (from commit 002f4ac35f)
- Error wrapping checked by errorlint
- Exhaustive switch statements required by exhaustive linter
- Follow [Effective Go](https://golang.org/doc/effective_go.html) guidelines
- Use `gosimports` for import formatting (run `make fmt`)
- Git commit messages: prefix with package name (e.g., `lnwire: fix typo in message`)
- Sign all commits with PGP
- Create atomic, easily reviewable commits
